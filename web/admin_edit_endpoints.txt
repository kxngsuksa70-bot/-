# PUT /api/admin/teachers/<id>
@app.route('/api/admin/teachers/<int:teacher_id>', methods=['DELETE', 'PUT'])
@role_required('teacher')
def admin_manage_teacher(teacher_id):
    if request.method == 'DELETE':
        result = db.delete_teacher(teacher_id)
        if result:
            return jsonify({'success': True, 'message': 'Teacher deleted'})
        return jsonify({'success': False, 'error': 'Failed to delete'}), 400
    
    elif request.method == 'PUT':
        data = request.get_json()
        conn = db.get_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database error'}), 500
        
        try:
            cursor = conn.cursor()
            username = data.get('username')
            
            # Check username conflict
            if username:
                cursor.execute("SELECT id FROM teachers WHERE username = %s AND id != %s", 
                             (username, teacher_id))
                if cursor.fetchone():
                    cursor.close()
                    conn.close()
                    return jsonify({'success': False, 'error': 'Username already taken'}), 400
            
            # Update
            if data.get('password'):
                cursor.execute("""
                    UPDATE teachers 
                    SET username=%s, password=%s, name=%s, subject=%s, contact=%s, room=%s 
                    WHERE id=%s
                """, (username, data['password'], data['name'], data.get('subject'), 
                     data.get('contact'), data.get('room'), teacher_id))
            else:
                cursor.execute("""
                    UPDATE teachers 
                    SET username=%s, name=%s, subject=%s, contact=%s, room=%s 
                    WHERE id=%s
                """, (username, data['name'], data.get('subject'), 
                     data.get('contact'), data.get('room'), teacher_id))
            
            conn.commit()
            cursor.close()
            conn.close()
            return jsonify({'success': True, 'message': 'Teacher updated'})
        except Exception as e:
            print(f"Error: {e}")
            return jsonify({'success': False, 'error': str(e)}), 500

# PUT /api/admin/students/<id>
@app.route('/api/admin/students/<int:student_id>', methods=['DELETE', 'PUT'])
@role_required('teacher')
def admin_manage_student(student_id):
    if request.method == 'DELETE':
        result = db.delete_student(student_id)
        if result:
            return jsonify({'success': True, 'message': 'Student deleted'})
        return jsonify({'success': False, 'error': 'Failed to delete'}), 400
    
    elif request.method == 'PUT':
        data = request.get_json()
        conn = db.get_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database error'}), 500
        
        try:
            cursor = conn.cursor()
            username = data.get('username')
            
            # Check username conflict
            if username:
                cursor.execute("SELECT id FROM students WHERE username = %s AND id != %s", 
                             (username, student_id))
                if cursor.fetchone():
                    cursor.close()
                    conn.close()
                    return jsonify({'success': False, 'error': 'Username already taken'}), 400
            
            # Update
            if data.get('password'):
                cursor.execute("""
                    UPDATE students 
                    SET username=%s, password=%s, name=%s 
                    WHERE id=%s
                """, (username, data['password'], data['name'], student_id))
            else:
                cursor.execute("""
                    UPDATE students 
                    SET username=%s, name=%s 
                    WHERE id=%s
                """, (username, data['name'], student_id))
            
            conn.commit()
            cursor.close()
            conn.close()
            return jsonify({'success': True, 'message': 'Student updated'})
        except Exception as e:
            print(f"Error: {e}")
            return jsonify({'success': False, 'error': str(e)}), 500
